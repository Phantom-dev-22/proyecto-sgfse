{% extends 'base.html' %}

{% block content %}
<div class="container d-flex justify-content-center align-items-center" style="min-height: 80vh;">
    
    <div class="card shadow-lg border-0" style="width: 100%; max-width: 450px;">
        <div class="card-body p-5 text-center">

            <div id="seccion-seleccion">
                <h2 class="text-primary fw-bold mb-3">Bienvenido al SGFSE</h2>
                <p class="text-muted mb-4">Sistema de Gestión de Flujo y Seguridad Escolar</p>
                <hr class="mb-4">
                <p class="mb-3 fw-bold">Seleccione su perfil para ingresar:</p>

                <div class="d-grid gap-3">
                    <button onclick="mostrarLogin('Administrador', 'bg-primary', 1)" class="btn btn-outline-primary btn-lg py-3 d-flex align-items-center justify-content-center gap-2 shadow-sm">
                        <i class="bi bi-person-badge-fill fs-4"></i> Administrador
                    </button>

                    <button onclick="mostrarLogin('Apoderado', 'bg-success', 2)" class="btn btn-outline-success btn-lg py-3 d-flex align-items-center justify-content-center gap-2 shadow-sm">
                        <i class="bi bi-people-fill fs-4"></i> Apoderado
                    </button>
                </div>
            </div>

            <div id="seccion-login" style="display: none;">
                <div id="encabezado-login" class="card text-white mb-4 p-3 shadow-sm" style="margin-top: -2rem; margin-left: -2rem; margin-right: -2rem; border-radius: 0.5rem 0.5rem 0 0;">
                    <h4 class="mb-0 fw-bold"><i class="bi bi-shield-lock-fill me-2"></i> Acceso <span id="titulo-rol">Usuario</span></h4>
                </div>

                <form action="{{ url_for('login') }}" method="POST" class="needs-validation" novalidate>
                    <input type="hidden" id="rol_entrada" name="rol_entrada" value="">

                    <div class="mb-3 text-start">
                        <label class="form-label fw-bold text-secondary">RUT de Usuario</label>
                        <input type="text" name="rut" class="form-control form-control-lg" placeholder="Ej: 12.345.678-9" required>
                        <div class="invalid-feedback">Por favor, ingresa tu RUT.</div>
                    </div>

                    <div class="mb-2 text-start"> 
                        <label class="form-label fw-bold text-secondary">Contraseña</label>
                        <div class="input-group">
                            <input type="password" name="clave" id="inputClaveLogin" class="form-control form-control-lg" placeholder="••••••••" required>
                            <button class="btn btn-outline-secondary" type="button" id="btnVerClaveLogin" title="Ver contraseña">
                                <i class="bi bi-eye-fill" id="iconoOjoLogin"></i>
                            </button>
                            <div class="invalid-feedback">La contraseña es obligatoria.</div>
                        </div>
                    </div>

                    <div class="mb-4 text-end">
                        <a href="{{ url_for('recuperar_clave') }}" class="small text-decoration-none text-muted fw-bold">
                            ¿Olvidaste tu contraseña?
                        </a>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg fw-bold shadow-sm">Ingresar</button>
                        <button type="button" onclick="volverSeleccion()" class="btn btn-light btn-lg border text-muted">Volver al Inicio</button>
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>

<script>
    // 1. Función para mostrar el formulario correcto
    function mostrarLogin(rol, claseColor, idRol) {
        document.getElementById('seccion-seleccion').style.display = 'none';
        
        document.getElementById('titulo-rol').textContent = rol;
        const header = document.getElementById('encabezado-login');
        header.className = `card text-white mb-4 p-3 shadow-sm ${claseColor}`;
        
        // Guardamos el ID (1 o 2) en el formulario oculto
        document.getElementById('rol_entrada').value = idRol;

        document.getElementById('seccion-login').style.display = 'block';
    }

    // 2. Función para volver y limpiar
    function volverSeleccion() {
        document.getElementById('seccion-login').style.display = 'none';
        document.getElementById('seccion-seleccion').style.display = 'block';

        const form = document.querySelector('.needs-validation');

        if (form) {
            form.reset(); 
            form.classList.remove('was-validated'); 
            
            // Resetear el ojito también (volver a ocultar si quedó abierto)
            const input = document.getElementById('inputClaveLogin');
            const icon = document.getElementById('iconoOjoLogin');
            input.type = 'password';
            icon.classList.remove('bi-eye-slash-fill');
            icon.classList.add('bi-eye-fill');
        }
    }
    
    // 3. Lógica del OJITO (Nuevo)
    const btnVer = document.getElementById('btnVerClaveLogin');
    const inputClave = document.getElementById('inputClaveLogin');
    const iconoOjo = document.getElementById('iconoOjoLogin');

    if(btnVer){
        btnVer.addEventListener('click', function() {
            if (inputClave.type === 'password') {
                inputClave.type = 'text';
                iconoOjo.classList.remove('bi-eye-fill');
                iconoOjo.classList.add('bi-eye-slash-fill');
            } else {
                inputClave.type = 'password';
                iconoOjo.classList.remove('bi-eye-slash-fill');
                iconoOjo.classList.add('bi-eye-fill');
            }
        });
    }

    // 4. Validación Bootstrap
    (function () {
        'use strict'
        var forms = document.querySelectorAll('.needs-validation')
        Array.prototype.slice.call(forms).forEach(function (form) {
            form.addEventListener('submit', function (event) {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }
                form.classList.add('was-validated')
            }, false)
        })
    })()
</script>
{% endblock %}